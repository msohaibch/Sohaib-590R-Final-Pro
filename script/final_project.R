# libraries to load
library(dplyr)
library(renv)
library(tidyverse)
library(here)
library(janitor)
library(gtsummary)
library(broom)
library(flextable)
summary(str)
# load the stroke dataset
stroke_raw <- read_csv(here("data", "raw", "StrockDataset.csv"))

# cleaning the data where gender=other, only 1 row
stroke_raw <- stroke_raw |>
	filter(is.na(gender) | tolower(gender) != "other")

# BMI to numeric and continuous variable
stroke_raw <- stroke_raw %>%
	mutate(bmi = as.numeric(bmi))

# recoding and creating new variables
stroke <- stroke_raw |>
	mutate(
		# gender
		gender = str_trim(gender),
		gender = factor(str_to_title(gender),
										levels = c("Male", "Female"),
										labels = c("Male", "Female")
		),
		# hypertension
		hypertension = factor(hypertension,
													levels = c(0, 1),
													labels = c("No", "Yes")
		),
		# heart disease
		heart_disease = factor(heart_disease,
													 levels = c(0, 1),
													 labels = c("No", "Yes")
		),
		# Ever married
		ever_married = factor(ever_married,
													levels = c("No", "Yes"),
													labels = c("No", "Yes")
		),
		# work type
		work_type = factor(work_type,
											 levels = c("Private", "Self-employed", "Govt_job", "children", "Never_worked"),
											 labels = c("Private", "Self-employed", "Government Job", "Children", "Never Worked")
		),
		# residence type
		residence_type = factor(Residence_type,
														levels = c("Urban", "Rural"),
														labels = c("Urban", "Rural")
		),
		# smoking status
		smoking_status = factor(smoking_status,
														labels = c("Formerly Smoked", "Never Smoked", "Currently Smokes", "Unknown")
		),
		# stroke outcome
		stroke = factor(stroke,
										levels = c(0, 1),
										labels = c("No Stroke", "Stroke")
		),
		# age groups
		age_group = cut(age,
										breaks = c(0, 20, 40, 60, Inf),
										labels = c("0-19", "20-39", "40-59", "60+"),
										right = FALSE
		),
		# BMI categories
		bmi_category = case_when(
			is.na(bmi) ~ NA_character_,
			bmi < 18.5 ~ "Underweight",
			bmi < 25   ~ "Normal",
			bmi < 30   ~ "Overweight",
			TRUE       ~ "Obese"
		),
		bmi_cat = factor(bmi_category,
										 levels = c("Underweight", "Normal", "Overweight", "Obese")
		),
		# glucose categories
		glucose_category = case_when(
			avg_glucose_level < 100      ~ "Normal",
			avg_glucose_level < 126      ~ "Prediabetic",
			avg_glucose_level >= 126 | is.na(avg_glucose_level) ~ "Diabetic"
		),
		glucose_cat = factor(glucose_category,
												 levels = c("Normal", "Prediabetic", "Diabetic")
		)
	)


# table 1: summary by stroke category
table1<-tbl_summary(
	stroke,
	by = stroke,
	include = c(
		age, age_group, bmi, gender, hypertension, heart_disease,
		ever_married, work_type, Residence_type,
		avg_glucose_level, glucose_cat, bmi_cat, smoking_status
	),
	label = list(
		age ~ "Age (years)",
		age_group ~ "Age Group",
		gender ~ "Gender",
		hypertension ~ "Hypertension",
		heart_disease ~ "Heart Disease",
		ever_married ~ "Ever Married",
		work_type ~ "Work Type",
		Residence_type ~ "Residence Type",
		avg_glucose_level ~ "Average Glucose Level (mg/dL)",
		glucose_cat ~ "Glucose Category",
		bmi ~ "Body Mass Index (kg/m²)",
		bmi_cat ~ "BMI Category",
		smoking_status ~ "Smoking Status"
	),
	missing_text = "Missing"
) |>
	add_p(
		test = list(
			all_continuous() ~ "t.test",
			all_categorical() ~ "chisq.test"
		),
		include = c(
			age, bmi, age_group, gender, hypertension, heart_disease,
			ever_married, Residence_type, avg_glucose_level, smoking_status
		)
	) |>
	add_overall(col_label = "**Total** N = {N}") |>
	bold_labels() |>
	modify_footnote(update = everything() ~ NA) |>
	modify_header(
		label = "**Variable**",
		p.value = "**P**"
	)


# table for univariate logistic regression
univariate_analysis_table <- tbl_uvregression(
	data = stroke,
	y = stroke, # factor with "Stroke" as event
	include = c(
		age, gender, hypertension, heart_disease,
		ever_married, residence_type,
		avg_glucose_level, bmi, smoking_status
	),
	method = glm,
	method.args = list(family = binomial()),
	exponentiate = TRUE, # report ORs
	label = list(
		age ~ "Age (years)",
		gender ~ "Gender",
		hypertension ~ "Hypertension",
		heart_disease ~ "Heart Disease",
		ever_married ~ "Ever Married",
		residence_type ~ "Residence Type",
		avg_glucose_level ~ "Average Glucose Level (mg/dL)",
		bmi ~ "Body Mass Index (kg/m²)",
		smoking_status ~ "Smoking Status"
	)
) |>
	add_n() |>
	bold_p(t = 0.05) |>
	modify_caption("**Table 2. Univariate Logistic Regression Analysis for Stroke Risk**")


#graphs

risk_factors <- stroke |>
	select(stroke, hypertension, heart_disease) |>
	pivot_longer(
		cols = c(hypertension, heart_disease),
		names_to = "risk_factor",
		values_to = "status"
	) |>
	filter(!is.na(status))

ggplot(risk_factors, aes(x = risk_factor, fill = stroke)) +
	geom_bar(position = "fill") +
	facet_wrap(~status) +
	labs(
		title = "Stroke Prevalence by Risk Factor Status",
		x = "Risk Factor",
		y = "Proportion",
		fill = "Stroke Status"
	) +
	theme_minimal() +
	theme(axis.text.x = element_text(angle = 45, hjust = 1))



ggplot(stroke, aes(x = age, fill = stroke)) +
	geom_histogram(binwidth = 5, alpha = 0.7, position = "dodge") +
	labs(
		title = "Age Distribution by Stroke Status",
		x = "Age (years)",
		y = "Count",
		fill = "Stroke Status"
	) +
	theme_minimal() +
	theme(legend.position = "bottom")




table1 |>
   as_flex_table() |>
   save_as_docx(path = "table1_descriptive.docx")

univariate_analysis_table |>
   as_flex_table() |>
   save_as_docx(path = "table2_univariate.docx")

#function to create age groups.
age_grouping <- function(x,
												cuts = c(0, 40, 60,  Inf),
												labels = c("<40", "40-59", "60+")) {
	cut(
		x,
		breaks = cuts,
		labels = labels,
		right = FALSE,
		ordered_result = TRUE
	)
}

#new dataset with different age grouping.
stroke_new_ages <- stroke |>
	mutate(age_group = age_grouping(age))


tbl_summary(
	stroke_new_ages,
	by = stroke,
	include = c(age_group, gender, hypertension, heart_disease, smoking_status, bmi, avg_glucose_level),
	label = list(age_group ~ "Age group")
)


